# preview-env.yml - GitOps Preview Environments
#
# Automatically provisions an ephemeral preview environment for every
# non-main branch push, and destroys it when the branch is merged or deleted.
#
# If a Dockerfile exists at the repo root (or path specified in .idp/config.yml),
# the image is built, pushed to ECR, and deployed. Otherwise, the configured
# container_image (default: nginx:alpine) is used.
#
# Configuration is read from .idp/config.yml in the repository root.

name: Preview Environment

on:
  push:
    branches-ignore:
      - main
      - master

  pull_request:
    types: [closed]

  delete:
    # Triggered when a branch is deleted

permissions:
  id-token: write
  contents: write
  pull-requests: write
  actions: write

# Prevent duplicate destroy runs when both pull_request[closed] and delete
# fire for the same branch. The second run is cancelled instead of failing
# with a Terraform state lock conflict.
concurrency:
  group: preview-${{ github.event.pull_request.head.ref || github.event.ref || github.ref_name }}
  cancel-in-progress: true

env:
  STATE_BUCKET: ${{ vars.STATE_BUCKET }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  ECR_REPO: ${{ vars.ECR_REPO }}

# -----------------------------------------------------------------
# Job 1: Setup â€” determine action, sanitize branch name, read config
# -----------------------------------------------------------------
jobs:
  setup:
    name: Setup
    # Skip tag deletions (we only care about branch deletions)
    if: github.event.ref_type != 'tag'
    uses: AnerSarid/mini-idp/.github/workflows/preview-setup.yml@main
    with:
      event_name: ${{ github.event_name }}
      ref_name: ${{ github.ref_name }}
      event_ref: ${{ github.event.ref }}
      pr_head_ref: ${{ github.event.pull_request.head.ref }}
      actor: ${{ github.actor }}
      use_shared_networking_default: ${{ vars.USE_SHARED_NETWORKING }}
    secrets: inherit

  # -----------------------------------------------------------------
  # Job 2: Build Image â€” build and push Docker image to ECR
  # -----------------------------------------------------------------
  build-image:
    name: Build Image
    needs: setup
    if: needs.setup.outputs.action == 'provision' || needs.setup.outputs.action == 'extend'
    runs-on: ubuntu-latest
    environment: production
    outputs:
      container_image: ${{ steps.resolve.outputs.container_image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine if Dockerfile exists
        id: check
        run: |
          set -euo pipefail
          DOCKERFILE="${{ needs.setup.outputs.dockerfile }}"

          # If dockerfile is explicitly set in config, use that path
          if [[ -n "$DOCKERFILE" ]]; then
            if [[ -f "$DOCKERFILE" ]]; then
              echo "has_dockerfile=true" >> "$GITHUB_OUTPUT"
              echo "dockerfile_path=${DOCKERFILE}" >> "$GITHUB_OUTPUT"
              echo "Found Dockerfile at configured path: ${DOCKERFILE}"
            else
              echo "::error::Configured dockerfile '${DOCKERFILE}' not found"
              exit 1
            fi
          # Otherwise, check for Dockerfile at repo root
          elif [[ -f "Dockerfile" ]]; then
            echo "has_dockerfile=true" >> "$GITHUB_OUTPUT"
            echo "dockerfile_path=Dockerfile" >> "$GITHUB_OUTPUT"
            echo "Found Dockerfile at repo root"
          else
            echo "has_dockerfile=false" >> "$GITHUB_OUTPUT"
            echo "No Dockerfile found, will use container_image from config"
          fi

      - name: Configure AWS credentials
        if: steps.check.outputs.has_dockerfile == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: steps.check.outputs.has_dockerfile == 'true'
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        if: steps.check.outputs.has_dockerfile == 'true'
        id: build
        run: |
          set -euo pipefail

          ECR_REGISTRY="${{ steps.ecr-login.outputs.registry }}"
          ECR_REPO="${{ env.ECR_REPO }}"
          ENV_NAME="${{ needs.setup.outputs.environment_name }}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="${ENV_NAME}-${SHORT_SHA}"
          FULL_IMAGE="${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

          BUILD_CONTEXT="${{ needs.setup.outputs.build_context }}"
          DOCKERFILE="${{ steps.check.outputs.dockerfile_path }}"

          echo "Building image: ${FULL_IMAGE}"
          echo "  Dockerfile: ${DOCKERFILE}"
          echo "  Context: ${BUILD_CONTEXT}"

          docker build \
            -t "${FULL_IMAGE}" \
            -f "${DOCKERFILE}" \
            --label "idp.environment=${ENV_NAME}" \
            --label "idp.commit=${{ github.sha }}" \
            --label "idp.branch=${{ github.ref_name }}" \
            "${BUILD_CONTEXT}"

          docker push "${FULL_IMAGE}"

          echo "image_uri=${FULL_IMAGE}" >> "$GITHUB_OUTPUT"
          echo "Image pushed: ${FULL_IMAGE}"

      - name: Resolve final container image
        id: resolve
        run: |
          set -euo pipefail
          if [[ "${{ steps.check.outputs.has_dockerfile }}" == "true" ]]; then
            echo "container_image=${{ steps.build.outputs.image_uri }}" >> "$GITHUB_OUTPUT"
          else
            echo "container_image=${{ needs.setup.outputs.container_image }}" >> "$GITHUB_OUTPUT"
          fi

  # -----------------------------------------------------------------
  # Job 3: Provision â€” create new preview environment
  # -----------------------------------------------------------------
  provision:
    name: Provision Preview
    needs: [setup, build-image]
    if: needs.setup.outputs.action == 'provision'
    uses: AnerSarid/mini-idp/.github/workflows/provision.yml@main
    with:
      template: ${{ needs.setup.outputs.template }}
      environment_name: ${{ needs.setup.outputs.environment_name }}
      owner: ${{ needs.setup.outputs.owner }}
      ttl: ${{ needs.setup.outputs.ttl }}
      container_image: ${{ needs.build-image.outputs.container_image }}
      container_port: ${{ needs.setup.outputs.container_port }}
      schedule_expression: ${{ needs.setup.outputs.schedule_expression }}
      s3_bucket_arn: ${{ needs.setup.outputs.s3_bucket_arn }}
      environment_variables: ${{ needs.setup.outputs.environment_variables }}
      secret_variables: ${{ needs.setup.outputs.secret_variables }}
      cpu: ${{ needs.setup.outputs.cpu }}
      memory: ${{ needs.setup.outputs.memory }}
      log_retention_days: ${{ needs.setup.outputs.log_retention_days }}
      acm_certificate_arn: ${{ vars.PREVIEW_ACM_CERT_ARN }}
      route53_zone_id: ${{ vars.PREVIEW_ZONE_ID }}
      preview_domain: ${{ vars.PREVIEW_DOMAIN }}
      use_shared_networking: ${{ needs.setup.outputs.use_shared_networking }}
    secrets: inherit

  # -----------------------------------------------------------------
  # Job 4: Extend & Redeploy â€” update TTL and deploy latest code
  # -----------------------------------------------------------------
  extend:
    name: Extend & Redeploy
    needs: [setup, build-image]
    if: needs.setup.outputs.action == 'extend'
    uses: AnerSarid/mini-idp/.github/workflows/provision.yml@main
    with:
      template: ${{ needs.setup.outputs.template }}
      environment_name: ${{ needs.setup.outputs.environment_name }}
      owner: ${{ needs.setup.outputs.owner }}
      ttl: ${{ needs.setup.outputs.ttl }}
      container_image: ${{ needs.build-image.outputs.container_image }}
      container_port: ${{ needs.setup.outputs.container_port }}
      schedule_expression: ${{ needs.setup.outputs.schedule_expression }}
      s3_bucket_arn: ${{ needs.setup.outputs.s3_bucket_arn }}
      environment_variables: ${{ needs.setup.outputs.environment_variables }}
      secret_variables: ${{ needs.setup.outputs.secret_variables }}
      cpu: ${{ needs.setup.outputs.cpu }}
      memory: ${{ needs.setup.outputs.memory }}
      log_retention_days: ${{ needs.setup.outputs.log_retention_days }}
      acm_certificate_arn: ${{ vars.PREVIEW_ACM_CERT_ARN }}
      route53_zone_id: ${{ vars.PREVIEW_ZONE_ID }}
      preview_domain: ${{ vars.PREVIEW_DOMAIN }}
      use_shared_networking: ${{ needs.setup.outputs.use_shared_networking }}
    secrets: inherit

  # -----------------------------------------------------------------
  # Job 5: Destroy â€” tear down preview environment
  # -----------------------------------------------------------------
  destroy:
    name: Destroy Preview
    needs: setup
    if: needs.setup.outputs.action == 'destroy'
    uses: AnerSarid/mini-idp/.github/workflows/destroy.yml@main
    with:
      environment_name: ${{ needs.setup.outputs.environment_name }}
    secrets: inherit

  # -----------------------------------------------------------------
  # Job 6: Comment â€” post preview URL on associated PR
  # -----------------------------------------------------------------
  comment:
    name: Comment on PR
    needs: [setup, provision, extend]
    # Run after provision OR extend (if either succeeded)
    if: |
      always() &&
      needs.setup.outputs.action != 'destroy' &&
      (needs.provision.result == 'success' || needs.extend.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Find associated PR and post comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          ENV_NAME="${{ needs.setup.outputs.environment_name }}"
          ACTION="${{ needs.setup.outputs.action }}"

          # Find PR for this branch
          PR_NUMBER=$(gh pr list \
            --repo "${{ github.repository }}" \
            --head "${{ github.ref_name }}" \
            --json number \
            --jq '.[0].number // empty' 2>/dev/null || echo "")

          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR found for branch ${{ github.ref_name }}, skipping comment."
            exit 0
          fi

          echo "Found PR #${PR_NUMBER}"

          # Fetch environment details from S3
          METADATA_KEY="environments/${ENV_NAME}/metadata.json"
          OUTPUTS_KEY="environments/${ENV_NAME}/outputs.json"

          EXPIRES_AT="unknown"
          ENDPOINT="pending"
          TEMPLATE="${{ needs.setup.outputs.template }}"

          if aws s3 cp "s3://${STATE_BUCKET}/${METADATA_KEY}" /tmp/metadata.json 2>/dev/null; then
            EXPIRES_AT=$(jq -r '.expires_at // "unknown"' /tmp/metadata.json)
          fi

          if aws s3 cp "s3://${STATE_BUCKET}/${OUTPUTS_KEY}" /tmp/outputs.json 2>/dev/null; then
            ENDPOINT=$(jq -r '.endpoint.value // .endpoint // "pending"' /tmp/outputs.json)
          fi

          if [[ "$ACTION" == "provision" ]]; then
            STATUS_EMOJI="ðŸš€"
            STATUS_TEXT="created"
          else
            STATUS_EMOJI="ðŸ”„"
            STATUS_TEXT="updated (TTL extended)"
          fi

          COMMENT_BODY="${STATUS_EMOJI} **Preview Environment ${STATUS_TEXT}**

          | | |
          |---|---|
          | **Environment** | \`${ENV_NAME}\` |
          | **URL** | ${ENDPOINT} |
          | **Template** | \`${TEMPLATE}\` |
          | **Expires** | ${EXPIRES_AT} |

          > This environment is automatically destroyed when this PR is merged or the branch is deleted.
          > TTL is extended on every push."

          # Check for existing preview comment to update instead of duplicate
          EXISTING_COMMENT_ID=$(gh api \
            "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | contains("Preview Environment")) | .id' \
            2>/dev/null | head -1 || echo "")

          if [[ -n "$EXISTING_COMMENT_ID" ]]; then
            echo "Updating existing comment ${EXISTING_COMMENT_ID}"
            gh api \
              --method PATCH \
              "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -f body="${COMMENT_BODY}"
          else
            echo "Creating new comment on PR #${PR_NUMBER}"
            gh pr comment "${PR_NUMBER}" \
              --repo "${{ github.repository }}" \
              --body "${COMMENT_BODY}"
          fi

  # -----------------------------------------------------------------
  # Job 7: Dashboard â€” update ENVIRONMENTS.md on main
  # -----------------------------------------------------------------
  dashboard:
    name: Update Dashboard
    needs: [setup, provision, extend, destroy]
    if: |
      always() &&
      (needs.provision.result == 'success' ||
       needs.extend.result == 'success' ||
       needs.destroy.result == 'success')
    uses: AnerSarid/mini-idp/.github/workflows/update-dashboard.yml@main
    secrets: inherit
