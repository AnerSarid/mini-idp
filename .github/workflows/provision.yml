name: Provision Environment

on:
  workflow_dispatch:
    inputs:
      template:
        description: "Infrastructure template"
        required: true
        type: choice
        options:
          - api-service
          - api-database
          - scheduled-worker
      environment_name:
        description: "Unique environment name (e.g. my-app-staging)"
        required: true
        type: string
      owner:
        description: "Owner email"
        required: true
        type: string
      ttl:
        description: "Time-to-live (e.g. 7d, 24h)"
        required: false
        type: string
        default: "7d"
      schedule_expression:
        description: "Schedule expression (scheduled-worker only)"
        required: false
        type: string
        default: ""
      s3_bucket_arn:
        description: "S3 bucket ARN (scheduled-worker only)"
        required: false
        type: string
        default: ""
      acm_certificate_arn:
        description: "ACM certificate ARN for HTTPS"
        required: false
        type: string
        default: ""
      route53_zone_id:
        description: "Route 53 zone ID for DNS record"
        required: false
        type: string
        default: ""
      preview_domain:
        description: "Base domain for preview environments (e.g. preview.anersarid.com)"
        required: false
        type: string
        default: ""
      container_image:
        description: "Container image URI (e.g. nginx:alpine or ECR URI)"
        required: false
        type: string
        default: "nginx:alpine"
      container_port:
        description: "Container port"
        required: false
        type: string
        default: "80"
      cpu:
        description: "CPU units for Fargate task (256, 512, 1024, 2048, 4096)"
        required: false
        type: string
        default: "256"
      memory:
        description: "Memory in MiB for Fargate task"
        required: false
        type: string
        default: "512"
      log_retention_days:
        description: "CloudWatch log retention in days (1, 3, 5, 7, 14, 30)"
        required: false
        type: string
        default: "3"
      environment_variables:
        description: "JSON-encoded map of environment variables"
        required: false
        type: string
        default: "{}"
      secret_variables:
        description: "JSON-encoded map of Secrets Manager ARN references"
        required: false
        type: string
        default: "{}"

  workflow_call:
    inputs:
      template:
        description: "Infrastructure template"
        required: true
        type: string
      environment_name:
        description: "Unique environment name"
        required: true
        type: string
      owner:
        description: "Owner email"
        required: true
        type: string
      ttl:
        description: "Time-to-live (e.g. 7d, 24h)"
        required: false
        type: string
        default: "7d"
      schedule_expression:
        description: "Schedule expression (scheduled-worker only)"
        required: false
        type: string
        default: ""
      s3_bucket_arn:
        description: "S3 bucket ARN (scheduled-worker only)"
        required: false
        type: string
        default: ""
      acm_certificate_arn:
        description: "ACM certificate ARN for HTTPS"
        required: false
        type: string
        default: ""
      route53_zone_id:
        description: "Route 53 zone ID for DNS record"
        required: false
        type: string
        default: ""
      preview_domain:
        description: "Base domain for preview environments (e.g. preview.anersarid.com)"
        required: false
        type: string
        default: ""
      container_image:
        description: "Container image URI (e.g. nginx:alpine or ECR URI)"
        required: false
        type: string
        default: "nginx:alpine"
      container_port:
        description: "Container port"
        required: false
        type: string
        default: "80"
      cpu:
        description: "CPU units for Fargate task (256, 512, 1024, 2048, 4096)"
        required: false
        type: string
        default: "256"
      memory:
        description: "Memory in MiB for Fargate task"
        required: false
        type: string
        default: "512"
      log_retention_days:
        description: "CloudWatch log retention in days (1, 3, 5, 7, 14, 30)"
        required: false
        type: string
        default: "3"
      environment_variables:
        description: "JSON-encoded map of environment variables"
        required: false
        type: string
        default: "{}"
      secret_variables:
        description: "JSON-encoded map of Secrets Manager ARN references"
        required: false
        type: string
        default: "{}"

permissions:
  id-token: write
  contents: read

env:
  STATE_BUCKET: ${{ vars.STATE_BUCKET }}
  AWS_REGION: ${{ vars.AWS_REGION }}
  LOCK_TABLE: ${{ vars.LOCK_TABLE }}

jobs:
  provision:
    name: Provision ${{ inputs.template }} / ${{ inputs.environment_name }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail

          # --- environment_name: lowercase alphanumeric + hyphens, 2-32 chars ---
          ENV_NAME="${{ inputs.environment_name }}"
          if [[ ! "$ENV_NAME" =~ ^[a-z0-9][a-z0-9-]{0,30}[a-z0-9]$ ]] && [[ ! "$ENV_NAME" =~ ^[a-z0-9]{2}$ ]]; then
            echo "::error::Invalid environment_name '${ENV_NAME}'. Must be 2-32 chars, lowercase alphanumeric and hyphens, cannot start/end with a hyphen."
            exit 1
          fi

          # --- template: must be a known value ---
          TEMPLATE="${{ inputs.template }}"
          if [[ "$TEMPLATE" != "api-service" && "$TEMPLATE" != "api-database" && "$TEMPLATE" != "scheduled-worker" ]]; then
            echo "::error::Invalid template '${TEMPLATE}'. Must be one of: api-service, api-database, scheduled-worker."
            exit 1
          fi

          # --- ttl: number followed by d or h ---
          TTL="${{ inputs.ttl }}"
          if [[ ! "$TTL" =~ ^[0-9]+[dh]$ ]]; then
            echo "::error::Invalid TTL '${TTL}'. Must be a number followed by d (days) or h (hours). Example: 7d, 24h."
            exit 1
          fi

          # --- container_port: valid port number ---
          PORT="${{ inputs.container_port }}"
          if [[ -n "$PORT" ]] && ! [[ "$PORT" =~ ^[0-9]+$ ]] || (( PORT < 1 || PORT > 65535 )); then
            echo "::error::Invalid container_port '${PORT}'. Must be a number between 1 and 65535."
            exit 1
          fi

          # --- schedule_expression: if template is scheduled-worker, must be provided ---
          SCHEDULE="${{ inputs.schedule_expression }}"
          if [[ "$TEMPLATE" == "scheduled-worker" && -z "$SCHEDULE" ]]; then
            echo "::error::schedule_expression is required for the scheduled-worker template."
            exit 1
          fi

          # --- environment_variables / secret_variables: must be valid JSON objects ---
          ENV_VARS='${{ inputs.environment_variables }}'
          if [[ -n "$ENV_VARS" && "$ENV_VARS" != "{}" ]]; then
            if ! echo "$ENV_VARS" | jq -e 'type == "object"' > /dev/null 2>&1; then
              echo "::error::environment_variables must be a valid JSON object. Got: ${ENV_VARS}"
              exit 1
            fi
          fi

          SECRET_VARS='${{ inputs.secret_variables }}'
          if [[ -n "$SECRET_VARS" && "$SECRET_VARS" != "{}" ]]; then
            if ! echo "$SECRET_VARS" | jq -e 'type == "object"' > /dev/null 2>&1; then
              echo "::error::secret_variables must be a valid JSON object. Got: ${SECRET_VARS}"
              exit 1
            fi
          fi

          echo "All inputs validated successfully."

      - name: Checkout infrastructure code
        uses: actions/checkout@v4
        with:
          repository: AnerSarid/mini-idp
          ref: main

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_wrapper: false

      - name: Compute timestamps and generate tfvars
        id: tfvars
        run: |
          set -euo pipefail

          CREATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          TTL_RAW="${{ inputs.ttl }}"
          if [[ "$TTL_RAW" =~ ^([0-9]+)d$ ]]; then
            TTL_SECONDS=$(( ${BASH_REMATCH[1]} * 86400 ))
          elif [[ "$TTL_RAW" =~ ^([0-9]+)h$ ]]; then
            TTL_SECONDS=$(( ${BASH_REMATCH[1]} * 3600 ))
          else
            echo "::error::Invalid TTL format. Use <number>d or <number>h."
            exit 1
          fi

          EXPIRES_AT=$(date -u -d "${CREATED_AT} + ${TTL_SECONDS} seconds" +"%Y-%m-%dT%H:%M:%SZ")

          mkdir -p infrastructure/environments
          TFVARS_FILE="infrastructure/environments/${{ inputs.environment_name }}.tfvars"

          # Base variables (all templates)
          cat > "${TFVARS_FILE}" <<TFEOF
          environment_name = "${{ inputs.environment_name }}"
          owner            = "${{ inputs.owner }}"
          ttl              = "${{ inputs.ttl }}"
          created_at       = "${CREATED_AT}"
          expires_at       = "${EXPIRES_AT}"
          TFEOF

          # Template-specific variables
          if [[ "${{ inputs.template }}" == "scheduled-worker" ]]; then
            cat >> "${TFVARS_FILE}" <<TFEOF
          schedule_expression = "${{ inputs.schedule_expression }}"
          s3_bucket_arn       = "${{ inputs.s3_bucket_arn }}"
          TFEOF
          fi

          # DNS and HTTPS variables (api-service and api-database templates)
          if [[ "${{ inputs.template }}" == "api-service" || "${{ inputs.template }}" == "api-database" ]]; then
            ACM_ARN="${{ inputs.acm_certificate_arn }}"
            ZONE_ID="${{ inputs.route53_zone_id }}"
            PREVIEW_DOMAIN="${{ inputs.preview_domain }}"
            if [[ -n "$ACM_ARN" ]]; then
              echo "acm_certificate_arn = \"${ACM_ARN}\"" >> "${TFVARS_FILE}"
            fi
            if [[ -n "$ZONE_ID" ]]; then
              echo "route53_zone_id = \"${ZONE_ID}\"" >> "${TFVARS_FILE}"
            fi
            if [[ -n "$PREVIEW_DOMAIN" ]]; then
              echo "preview_domain = \"${PREVIEW_DOMAIN}\"" >> "${TFVARS_FILE}"
            fi
          fi

          # Container configuration (all templates)
          CONTAINER_IMAGE="${{ inputs.container_image }}"
          CONTAINER_PORT="${{ inputs.container_port }}"
          if [[ -n "$CONTAINER_IMAGE" && "$CONTAINER_IMAGE" != "nginx:alpine" ]]; then
            echo "container_image = \"${CONTAINER_IMAGE}\"" >> "${TFVARS_FILE}"
          fi
          if [[ -n "$CONTAINER_PORT" && "$CONTAINER_PORT" != "80" ]]; then
            echo "container_port = ${CONTAINER_PORT}" >> "${TFVARS_FILE}"
          fi

          # Resource sizing
          CPU="${{ inputs.cpu }}"
          MEMORY="${{ inputs.memory }}"
          if [[ -n "$CPU" && "$CPU" != "256" ]]; then
            echo "cpu = ${CPU}" >> "${TFVARS_FILE}"
          fi
          if [[ -n "$MEMORY" && "$MEMORY" != "512" ]]; then
            echo "memory = ${MEMORY}" >> "${TFVARS_FILE}"
          fi

          # Log retention
          LOG_RETENTION="${{ inputs.log_retention_days }}"
          if [[ -n "$LOG_RETENTION" && "$LOG_RETENTION" != "3" ]]; then
            echo "log_retention_days = ${LOG_RETENTION}" >> "${TFVARS_FILE}"
          fi

          # Environment variables (JSON map → HCL map)
          ENV_VARS='${{ inputs.environment_variables }}'
          if [[ -n "$ENV_VARS" && "$ENV_VARS" != "{}" ]]; then
            echo "" >> "${TFVARS_FILE}"
            echo "environment_variables = {" >> "${TFVARS_FILE}"
            echo "$ENV_VARS" | jq -r 'to_entries[] | "  \(.key) = \"\(.value)\""' >> "${TFVARS_FILE}"
            echo "}" >> "${TFVARS_FILE}"
          fi

          # Secret variables (JSON map → HCL map)
          SECRET_VARS='${{ inputs.secret_variables }}'
          if [[ -n "$SECRET_VARS" && "$SECRET_VARS" != "{}" ]]; then
            echo "" >> "${TFVARS_FILE}"
            echo "secret_variables = {" >> "${TFVARS_FILE}"
            echo "$SECRET_VARS" | jq -r 'to_entries[] | "  \(.key) = \"\(.value)\""' >> "${TFVARS_FILE}"
            echo "}" >> "${TFVARS_FILE}"
          fi

          # Remove leading whitespace from heredoc indentation
          sed -i 's/^          //' "${TFVARS_FILE}"

          echo "tfvars_file=${TFVARS_FILE}" >> "$GITHUB_OUTPUT"
          echo "created_at=${CREATED_AT}" >> "$GITHUB_OUTPUT"
          echo "expires_at=${EXPIRES_AT}" >> "$GITHUB_OUTPUT"

      - name: Tofu init
        working-directory: infrastructure/templates/${{ inputs.template }}
        run: |
          tofu init -input=false \
            -backend-config="bucket=${STATE_BUCKET}" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${LOCK_TABLE}" \
            -backend-config="key=environments/${{ inputs.environment_name }}/terraform.tfstate"

      - name: Tofu plan
        working-directory: infrastructure/templates/${{ inputs.template }}
        run: |
          tofu plan \
            -var-file="${{ github.workspace }}/${{ steps.tfvars.outputs.tfvars_file }}" \
            -out=tfplan \
            -input=false \
            -lock-timeout=5m

      - name: Tofu apply
        working-directory: infrastructure/templates/${{ inputs.template }}
        run: tofu apply -input=false -lock-timeout=5m tfplan

      - name: Upload outputs to S3
        working-directory: infrastructure/templates/${{ inputs.template }}
        run: |
          set -euo pipefail
          tofu output -json > outputs.json
          aws s3 cp outputs.json \
            "s3://${STATE_BUCKET}/environments/${{ inputs.environment_name }}/outputs.json" \
            --content-type "application/json"

      - name: Upload metadata to S3
        run: |
          set -euo pipefail
          cat > metadata.json <<EOF
          {
            "name": "${{ inputs.environment_name }}",
            "template": "${{ inputs.template }}",
            "owner": "${{ inputs.owner }}",
            "ttl": "${{ inputs.ttl }}",
            "created_at": "${{ steps.tfvars.outputs.created_at }}",
            "expires_at": "${{ steps.tfvars.outputs.expires_at }}",
            "status": "active",
            "container_image": "${{ inputs.container_image }}",
            "acm_certificate_arn": "${{ inputs.acm_certificate_arn }}",
            "route53_zone_id": "${{ inputs.route53_zone_id }}",
            "preview_domain": "${{ inputs.preview_domain }}"
          }
          EOF
          sed -i 's/^          //' metadata.json
          aws s3 cp metadata.json \
            "s3://${STATE_BUCKET}/environments/${{ inputs.environment_name }}/metadata.json" \
            --content-type "application/json"
